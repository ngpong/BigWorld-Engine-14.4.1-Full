#!/usr/bin/env python

# This script is useful for generating a user's ~/.bwmachined.conf file.
# See usage for more information.

import re
import shutil
import sys
import os.path
import optparse

DEFAULT_INSTALL_ROOT="/opt/bigworld/current/server"
DEFAULT_GAME_RES_PATH="~/my_game/res"

USAGE = """usage: %prog [options] [game_res_path]
Configures a user's account for running a BigWorld server by generating a
~/.bwmachined.conf file."""


try:
	import readline
except ImportError:
	pass


class FatalError( Exception ):
	def __init__( self, msg ):
		self.msg = msg

class NoProjectExistsError( FatalError ):
	pass

class PathError( FatalError ):
	def __init__( self, path, memberPath = None ):
		if memberPath:
			FatalError.__init__( self,
				"%s does not contain %s : Invalid directory" %
					(path, memberPath) )
		else:
			FatalError.__init__( self, "%s : No such directory" % path )


def expandFilename( filename ):
	if filename:
		return os.path.abspath(
				os.path.expandvars(
					os.path.expanduser( filename ) ) )
	else:
		return filename


def inputFilename( prompt ):
	return expandFilename( raw_input( prompt ) )


def inputPath( prompt, default ):
	path = inputFilename( "%s [%s]: " % (prompt, default) )

	if path == "":
		path = os.path.expanduser( default )

	return path


def promptAndCreatePath( dirToCreate ):

	if os.path.split( dirToCreate )[ -1 ] == "res":
		dirToCreate = os.path.dirname( dirToCreate )

		if len( dirToCreate ) == 0:
			raise FatalError( "Unable to create project directory named 'res'" )

	print "'%s' project directory not found." % dirToCreate

	try:
		import bw_create_new_project
	except ImportError:
		# This is only enabled in the RPM package as the bw_create_new_project
		# script resides in the tutorial directory. Running bw_configure from
		# bigworld/tools/server has no knowledge of 'tutorial'
		print "Feature to create project directory is disabled (RPM only)"
		return None


	defaultInput = "N"

	while True:
		input = raw_input( "Create '%s' with tutorial resources [y/N]? " % dirToCreate )
		if len( input ) == 0:
			input = defaultInput

		if re.match( "^[yY]([eE][sS])?$", input ):
			fullDirToCreate = expandFilename( dirToCreate )

			try:
				bw_create_new_project.createNewProject(
					os.path.abspath( fullDirToCreate ) )

			except Exception, e:
				print "Removing partially created tree"
				shutil.rmtree( fullDirToCreate )
				raise FatalError( e.message )

			return fullDirToCreate
		elif re.match( "^[nN][oO]?$", input ):
			return None


def writeConfFile( filename, installRoot, bigworldResPath, gameResPath ):
	filename = os.path.expanduser( "~/.bwmachined.conf" )

	if os.path.exists( filename ):
		backupFilename = filename + ".bak"
		os.rename( filename, backupFilename )

	try:
		f=open( filename, 'w' )
		print >>f, "# Generated by %s" % sys.argv[0]
		print >>f, "%s;%s:%s" % (installRoot, gameResPath, bigworldResPath)
		f.close()
	except int:
		print "Failed to write to", filename
	else:
		print "Writing to %s succeeded" % filename
		print
		print "Installation root :", installRoot
		print "BigWorld resources:", bigworldResPath
		print "Game resources    :", gameResPath


def isValidPath( path, extraPath = None ):
	if not os.path.isdir( path ):
		return False

	if extraPath and not os.path.exists( path + '/' + extraPath ):
		raise PathError( path, extraPath )

	return True


# This method attempts to get a valid path for an option.
# @param cmdLineArg The value, if any, specified on the command line for this
#			option.
# @param autoDefault	The default path to try first before prompting.
# @param prompt		The prompt to display if prompting the user.
# @param memberPath	A sub-path to test exists inside the path.
# @param altPath	A sub-path to test if the input path fails.
# @param displayDefault The default path to display when prompting
def getPath( prompt, cmdLineArg, autoDefault = None,
					memberPath = None, altPath = None, displayDefault = None ):

	if cmdLineArg is not None:
		path = cmdLineArg
	else:
		isValidDefault = False
		if autoDefault != None:
			path = expandFilename( autoDefault )
			isValidDefault = isValidPath( path )

		if not isValidDefault:
			if displayDefault is None:
				displayDefault = autoDefault

			path = inputPath( prompt, displayDefault )

	try:
		if not isValidPath( path, memberPath ):

			# If we haven't found the requested game path, check if the user
			# wants to create it before failing completely.
			dirToCreate = displayDefault
			if cmdLineArg:
				dirToCreate = cmdLineArg

			createdPath = promptAndCreatePath( dirToCreate )
			if createdPath is None:
				raise NoProjectExistsError(
					"%s does not exist and was not created" % path )

			# The path that is created is a base directory, so we must point
			# to the res path for .bwmachined.conf
			path = os.path.join( createdPath, "res" )

	except PathError:
		if altPath:
			altPath = os.path.abspath( path + '/' + altPath )

			if isValidPath( altPath, memberPath ):
				return altPath
		raise

	return path


def parseOptions():
	opt = optparse.OptionParser( usage = USAGE )

	opt.add_option( "-i", "--install-path",
		dest = "bigworld_root",
		default = None,
		help = "Specify the directory where BigWorld is installed" )

	opt.add_option( "-b", "--bigworld-res",
		dest = "bigword_res_path",
		default = None,
		help = "Specify the directory where BigWorld resources are installed" )

	options, args = opt.parse_args()

	gameRes = None

	if len( args ) == 1:
		gameRes = args[0]

	if len( args ) >= 2:
		opt.print_help()
		raise FatalError( "Invalid number of arguments" )

	return options.bigworld_root, options.bigword_res_path, gameRes


def main( installOption, bigworldOption, gameResOption ):
	installRoot = getPath( "Installation root", installOption,
		DEFAULT_INSTALL_ROOT,
		displayDefault = "~/mf",
		memberPath = "bigworld/bin" )

	# Could be <install>/bigworld/res or <install>/res. Try both.
	defaultBigWorldRes = installRoot + "/bigworld/res"

	if not isValidPath( defaultBigWorldRes ):
		altBigWorldRes = installRoot + "/res"
		if isValidPath( altBigWorldRes ):
			defaultBigWorldRes = altBigWorldRes

	bigworldResPath = getPath( "BigWorld resource path", bigworldOption,
		defaultBigWorldRes )

	gameResPath = getPath( "Game resource path", gameResOption,
			displayDefault = DEFAULT_GAME_RES_PATH,
			memberPath = "server/bw.xml",
			altPath = "res" )

	writeConfFile( "~/.bwmachined.conf",
		installRoot, bigworldResPath, gameResPath )


if __name__ == "__main__":
	try:
		if os.getuid() == 0:
			raise FatalError(
				"%s should not be run by the root user." % sys.argv[0] )

		args = parseOptions()
		main( *args )
	except FatalError, e:
		print e.msg
		sys.exit( 1 )
	except KeyboardInterrupt:
		print
		sys.exit( 1 )

# bw_configure
